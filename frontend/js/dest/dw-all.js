var doraWorld=angular.module("doraWorld",["ui.router","duScroll","ngAnimate","ui.bootstrap","angular-loading-bar","toastr","bootstrap-switch","common","dw.controllers"]);doraWorld.config(["$urlRouterProvider","$locationProvider","$stateProvider",function(e,n,t){n.html5Mode(!0),e.otherwise("/")}]),doraWorld.config(["$stateProvider",function(e){e.state("home",{url:"/",templateUrl:"/templates/home/homePage.html",controller:"HomePageController"}).state("pic_wall",{url:"/pic_wall",templateUrl:"/templates/pic_wall/picWall.html",controller:"PicWallController",resolve:{test_str:["$stateParams",function(e){return"this is a test"}]}}).state("about",{url:"/about",templateUrl:"/templates/about/about.html",controller:"AboutController"})}]);var dwControllers=angular.module("dw.controllers",[]);dwControllers.controller("AboutController",[function(){}]);var common=angular.module("common",["ngCookies"]);common.controller("MainMenuController",["$rootScope","$scope","$state","toastr","commonModalFactory","dwSecurity",function(e,n,t,o,r,c){function u(t){var o=[];angular.forEach(t,function(e){a[e]&&o.push(a[e])}),e.user&&e.user.id?o.push(a.signOut):o.push(a.signIn),n.menu.buttons=angular.copy(o)}n.menuOpened=!1;var s={buttons:[{name:"登录注册",icon:"sign-in",click:function(){n.closeMenu(),r.showSignInModal()}}],navigations:[{name:"首页",icon:"home",click:function(){n.closeMenu(),t.go("home")}},{name:"照片墙",icon:"photo",click:function(){n.closeMenu(),t.go("pic_wall")}},{name:"讨论专区",icon:"comments-o"},{name:"数据统计",icon:"area-chart"},{name:"关于本站",icon:"info",click:function(){n.closeMenu(),t.go("about")}}]},a={signIn:{name:"登录注册",icon:"sign-in",click:function(){n.closeMenu(),r.showSignInModal()}},signOut:{name:"退出登录",icon:"sign-out",click:function(){c.logout().then(function(e){o.success("bye~")}),n.closeMenu()}},currentUser:{name:"用户中心",icon:"user-circle",click:function(){n.closeMenu(),t.go("current_user")}},addAlbum:{name:"创建专辑",icon:"plus-square",click:function(){n.closeMenu()}},addArticle:{name:"撰写文章",icon:"pencil-square",click:function(){n.closeMenu()}}};n.menu=angular.copy(s),n.toggleMenu=function(){n.menuOpened=!n.menuOpened},n.closeMenu=function(){n.menuOpened=!1},n.$on("dw::security::login",function(){e.user=c.currentUser(),console.log(e.user),u(["addArticle","addAlbum","currentUser"])}),n.$on("dw::security::logout",function(){e.user=c.currentUser(),u()}),n.$on("cc::menu::close",function(){n.closeMenu()}),n.$on("cc::menu::reset",function(){n.menu.buttons=angular.copy(s)}),n.$on("cc::menu::set-buttons",u),n.viewProfile=function(){e.user&&e.user._id&&t.go("profile",{id:e.user._id})}}]),common.directive("busy",[function(){return{restrict:"A",template:'<button class="btn btn-sm" ng-click="click()" ng-disabled="disabled() || isBusy"> <span ng-if="isBusy"><i ng-class="icon"></i></span> <span ng-transclude></span> </button>',replace:!0,transclude:!0,scope:{busy:"&",busyIcon:"@",busyDisabled:"&"},link:function(e,n,t){e.isBusy=!1,e.icon=e.busyIcon||"fa fa-spinner fa-spin",e.disabled=e.busyDisabled||function(){return!1},e.click=function(){var n=e.busy();"object"==typeof n&&"function"==typeof n.finally&&(e.isBusy=!0,n.finally(function(){e.isBusy=!1}))}}}}]),common.config(["$stateProvider",function(e){e.state("current_user",{url:"/c_user",templateUrl:"/templates/common/account/currentUser.html",controller:"CurrentUserController"})}]),common.factory("commonModalFactory",["$modal",function(e){return{showSignInModal:function(){return e.open({templateUrl:"/templates/common/account/sign_in.html",controller:"SignInController"}).result},showPagedownHelpModal:function(){return e.open({templateUrl:"/modules/framework/pagedownHelpModal.html",controller:"PagedownHelpModalController"}).result}}}]),common.factory("safeApply",["$rootScope",function(e){return function(n){e.$$phase?n():e.$apply(n)}}]),common.factory("promiseService",["$q","safeApply",function(e,n){var t=function(){var t=e.defer();return{resolve:function(e){n(function(){t.resolve(e)})},reject:function(e){n(function(){t.reject(e)})},promise:t.promise}},o=function(n,t){return n(t),e.all(t)};return{all:function(n){return e.all(n)},chain:function(n){return function(n,t){var o=e.defer(),r=o.promise,c=[];n(t);var u=function(e){return r.then(function(n){return n instanceof Array?c=c.concat(n):n&&c.push(n),e?e():c},function(e){throw e})};return angular.forEach(t,function(e){r=u(e)}),o.resolve(),u()}(n,[])},wrap:function(e){var n=t();return e(n),n.promise},wrapAll:function(e){return o(e,[])},arrayWrap:function(e){return o(e,[])},objectWrap:function(e){return o(e,{})},throwError:function(e){throw e},defer:t}}]),common.factory("localStore",["$cookieStore","$window",function(e,n){return{setItem:function(t,o){n.localStorage?n.localStorage.setItem(t,JSON.stringify(o)):e.put(t,o)},getItem:function(t,o){return n.localStorage?JSON.parse(n.localStorage.getItem(t))||o:e.get(t)||o},removeItem:function(t){n.localStorage?n.localStorage.removeItem(t):e.remove(t)}}}]),common.factory("commonUtils",[function(){return{random_string:function(e){e=e||32;for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=n.length,o="",r=0;r<e;r++)o+=n.charAt(Math.floor(Math.random()*t));return o}}}]);var CONSTANT={HOST:"http://localhost:3001/"};dwControllers.controller("HomePageController",["$state","$scope",function(e,n){n.toAlbums=function(){e.go("albums")},n.join=function(){}}]),dwControllers.controller("PicWallController",["$state","$scope","$window","$http","test_str",function(e,n,t,o,r){n.test_str=r,n.pics=[],n.getAllPics=function(){o.get("/api/pic_wall/gets_all").success(function(e){n.pics=e})},n.changePic=function(e){var n=e.srcElement||e.target,o=angular.element(t);console.log(o),angular.element("#bigimage")[0].src=n.src,angular.element("#js-imgview")[0].style.display="block",angular.element("#js-imgview-mask")[0].style.display="block"},n.closePic=function(){angular.element("#js-imgview")[0].style.display="none",angular.element("#js-imgview-mask")[0].style.display="none"},n.getAllPics()}]),common.controller("CurrentUserController",[function(){}]),common.controller("SignInController",["$scope","$modalInstance","toastr","dwSecurity",function(e,n,t,o){e.mode="login",e.userData={},e.close=function(){e.cancel()},e.cancel=function(){n.dismiss("cancel")},e.toggle=function(){"login"===e.mode?e.mode="register":e.mode="login",e.message=void 0},e.formValid=function(n){var t=!0;return n.username.$valid||(t=!1),"login"===e.mode?n.password.$valid||(t=!1):n.password.$valid&&e.userData.password===e.userData.password2&&n.username.$valid||(t=!1),t},e.register=function(){return o.register(e.userData.email,e.userData.password,e.userData.username).then(function(n){e.message=o.lastMessage()},function(n){e.message=o.lastMessage()})},e.login=function(){return o.login(e.userData.username,e.userData.password).then(function(n){t.success("欢迎来到哆啦e漫, "+n.user_name,"欢迎"),e.close()},function(n){e.message=o.lastMessage()})},e.forgotPassword=function(){return o.forgotPassword(e.userData.username).then(function(n){e.message=o.lastMessage()},function(n){e.message=o.lastMessage()})}}]),common.factory("dwSecurityApi",["$http","promiseService",function(e,n){return{register:function(t,o,r){return n.wrap(function(n){e.post(CONSTANT.HOST+"api/account/register",{email:t,password:o,username:r}).then(function(e){n.resolve(e.data)},n.reject)})},login:function(t,o){return n.wrap(function(n){e.post(CONSTANT.HOST+"login",{username:t,password:o}).then(function(e){n.resolve(e.data)},n.reject)})},logout:function(){return n.wrap(function(n){e.post(CONSTANT.HOST+"logout").then(function(e){n.resolve(e.data)},n.reject)})},getCurrentUser:function(){return n.wrap(function(n){e.get(CONSTANT.HOST+"current_user").then(function(e){n.resolve(e.data)},n.reject)})},forgotPassword:function(t){return n.wrap(function(n){e.post(CONSTANT.HOST+"api/account/forgot_password",{user_name:t}).then(function(e){n.resolve(e.data)},n.reject)})}}}]),common.provider("dwSecurity",["$httpProvider",function(){var e=void 0;return{$get:["$rootScope","dwSecurityApi","localStore","promiseService",function(n,t,o,r){function c(){return o.getItem("user")}function u(e){return o.setItem("user",e),e}function s(){o.removeItem("user"),a=void 0}var a=c();return t.getCurrentUser().then(function(e){null!==e.user&&(a=u(e.user),n.$broadcast("dw::security::login",a))}),n.$on("dw::security::logout",function(){o.removeItem("user")}),{lastMessage:function(){return e},currentUser:function(){return a},register:function(n,o,c){return r.wrap(function(r){t.register(n,o,c).then(function(n){e=(n.error,{type:"warning",text:n.message}),r.resolve()},function(n){e=400===n.status?{type:"danger",text:"您刚刚提交了一个无效的请求, 请通过源艺页面提交注册."}:{type:"danger",text:"用户注册遇到问题, 请您稍后重试."},r.reject(n)})})},login:function(o,i){return r.wrap(function(r){t.login(o,i).then(function(e){e.user?(u(e.user),a=c(),n.$broadcast("dw::security::login",a),r.resolve(e.user)):(s(),r.reject())},function(n){e=404===n.status?{type:"danger",text:"身份验证失败, 请检查您输入的电子邮箱和登录密码."}:{type:"danger",text:"身份验证遇到问题, 请稍后重试."},s(),r.reject(n)})})},logout:function(){return r.wrap(function(e){t.logout().then(function(t){s(),n.$broadcast("dw::security::logout"),e.resolve()},function(n){s(),e.reject(n)})})},forgotPassword:function(n){return r.wrap(function(o){t.forgotPassword(n).then(function(n){"Email sent."==n.message&&(e={type:"info",text:"密码重置链接已发送至您的邮箱, 请登录邮箱并重置您的密码."}),o.resolve()},function(n){e=404===n.status?{type:"warning",text:"该邮箱尚未注册, 请您检查输入的用户名或进行注册."}:{type:"danger",text:"找回密码遇到问题, 请您稍后重试."},o.reject(n)})})}}}]}}]);